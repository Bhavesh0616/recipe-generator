<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AI Meal Planner</title>
<style>
  :root{
    --teal:#00a6a6;
    --yellow:#ffd966;
    --bg:#f4fafa;
    --danger:#ff5c5c;
    --card:#ffffff;
    --shadow:0 4px 8px rgba(0,0,0,0.1);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:'Segoe UI', system-ui, -apple-system, Roboto, Arial, sans-serif;
    background-color:var(--bg);
    display:flex;
    height:100vh;
    color:#1b1b1b;
  }
  .sidebar{
    background-color:var(--teal);
    width:300px;
    padding:20px;
    color:#fff;
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .logo{
    font-size:1.4rem;
    font-weight:700;
    display:flex;
    align-items:center;
    gap:8px;
    margin-bottom:8px;
  }
  .new-chat-btn{
    background-color:rgba(255,255,255,0.2);
    border:none;
    padding:12px;
    border-radius:10px;
    color:#fff;
    font-size:1rem;
    display:flex;
    align-items:center;
    gap:8px;
    cursor:pointer;
    transition:background-color .2s ease-in-out, transform .04s ease-in-out;
  }
  .new-chat-btn:hover{ background-color:rgba(255,255,255,0.3); }
  .new-chat-btn:active{ transform:scale(0.98); }

  /* Chat list in sidebar */
  #chatList{
    margin-top:8px;
    display:flex;
    flex-direction:column;
    gap:8px;
    overflow:auto;
  }
  .chat-item{
    background:rgba(255,255,255,0.14);
    border:none;
    padding:10px 12px;
    border-radius:10px;
    color:#fff;
    text-align:left;
    cursor:pointer;
    display:flex;
    gap:8px;
    align-items:center;
  }
  .chat-item.active{
    background:rgba(255,255,255,0.28);
    outline:2px solid rgba(255,255,255,0.35);
  }

  .main{
    flex:1;
    padding:32px 40px;
    overflow:auto;
  }
  h1{
    color:var(--teal);
    font-size:2rem;
    text-align:center;
    margin:0 0 24px 0;
  }
  .controls{
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:16px;
    justify-content:center;
    flex-wrap:wrap;
  }
  select{
    padding:8px 10px;
    border-radius:10px;
    border:1px solid #ccc;
    background-color:var(--yellow);
    font-weight:600;
  }
  textarea{
    width:100%;
    height:90px;
    border-radius:12px;
    border:1px solid var(--teal);
    padding:10px;
    resize:none;
    font-size:1rem;
    margin-bottom:16px;
    background:#fff;
  }
  .health-filters{
    display:flex;
    flex-wrap:wrap;
    gap:14px;
    margin-bottom:18px;
    justify-content:center;
  }
  .health-filters label{
    display:flex;
    align-items:center;
    gap:6px;
    font-size:.95rem;
    background:#ffffff;
    padding:6px 10px;
    border-radius:10px;
    box-shadow:var(--shadow);
  }
  .actions{
    display:flex;
    gap:12px;
    justify-content:center;
    margin-bottom:14px;
  }
  .btn{
    padding:10px 18px;
    border-radius:12px;
    font-size:1rem;
    cursor:pointer;
    border:none;
  }
  .btn-primary{ background-color:var(--teal); color:#fff; }
  .btn-stop{ background-color:var(--danger); color:#fff; }
  .recipes{
    margin-top:18px;
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));
    gap:18px;
  }
  .recipe-card{
    background:var(--card);
    border-radius:12px;
    padding:16px;
    box-shadow:var(--shadow);
  }
  
  .muted{opacity:.8;font-size:.9rem}

  .chat-history {
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    box-shadow: var(--shadow);
  }
  .chat-msg {
    border-bottom: 1px solid #eee;
    padding-bottom: 8px;
  }

  .mic-input-group {
    position: relative;
    display: flex;
    align-items: center;
  }

  #ingredients {
    flex: 1;
    padding-right: 40px; /* space for mic button */
  }

  .mic-icon {
    position: absolute;
    right: 14px;
    top: 50%;
    transform: translateY(-50%);
    width: 36px;
    height: 36px;
    background-color: #fff;
    border-radius: 50%;
    padding: 6px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.4);
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .mic-icon:hover {
    background-color: #333;
  }

  .mic-icon.listening {
    background-color: #d32f2f;
  }

  .nutrition-btn {
    background-color: #00a6a6;
    color: white;
    border: none;
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
    float: none;
    margin-top: 0;
  }

  .nutrition-popup {
    display: none;
    position: fixed;
    z-index: 9999;
    top: 20%;
    left: 50%;
    transform: translate(-50%, -20%);
    background-color: white;
    border: 2px solid #00a6a6;
    padding: 16px;
    border-radius: 10px;
    min-width: 250px;
    max-width: 400px;
    box-shadow: 0 0 12px rgba(0, 0, 0, 0.2);
  }

  .nutrition-popup-close {
    float: right;
    font-size: 18px;
    cursor: pointer;
  }

</style>
</head>
<body>
  <div class="sidebar">
    <div class="logo">üß† AI Meal Planner</div>
    <button class="new-chat-btn" id="btnNewChat">‚ûï New Ingredient Chat</button>

    <!-- Sidebar chat list -->
    <div id="chatList" aria-label="Chats"></div>
    <div class="muted" style="margin-top:auto; font-size:.85rem;">
      Tip: Click a chat to make it active. All messages save into its JSON.
    </div>
  </div>

  <div class="main">
    <h1>My Meal Planner</h1>

    <div class="controls">
      <label for="displayLang">Choose your language:</label>
      <select id="displayLang" aria-label="Display Language">
        <option value="auto">Auto Detect</option>
        <option value="en">English (en)</option>
        <option value="fr">Fran√ßais (fr)</option>
        <option value="de">Deutsch (de)</option>
        <option value="es">Espa√±ol (es)</option>
        <option value="it">Italiano (it)</option>
        <option value="pt">Portugu√™s (pt)</option>
        <option value="ru">–†—É—Å—Å–∫–∏–π (ru)</option>
        <option value="ja">Êó•Êú¨Ë™û / Japanese (ja)</option>
        <option value="ko">ÌïúÍµ≠Ïñ¥ / Korean (ko)</option>
        <option value="zh">‰∏≠Êñá / Chinese (zh)</option>
        <option value="th">‡πÑ‡∏ó‡∏¢ / Thai (th)</option>
        <option value="tr">T√ºrk√ße / Turkish (tr)</option>
        <option value="vi">Ti·∫øng Vi·ªát / Vietnamese (vi)</option>
        <option value="sw">Swahili</option>
        <option value="lg">Lugando</option>
        <option value="lao">Lango</option>
        <option value="ach">Acholi</option>
        <option value="lug">Lugiso</option>
        <option value="teo">Iteso</option>
        <option value="nyn">Runyankele-Rukiga</option>
        <option value="nqo">Runyoro-Kitalu</option>
        <option value="xog">Lusoga</option>
        <option value="teo">Ateso</option>
        <option value="bwb">Lubwisi</option>
        <option value="lgg">Lugbara</option>
        <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä / Hindi (hi)</option>
        <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ / Bengali (bn)</option>
        <option value="mr">‡§Æ‡§∞‡§æ‡§†‡•Ä / Marathi (mr)</option>
        <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç / Tamil (ta)</option>
        <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å / Telugu (te)</option>
        <option value="gu">‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä / Gujarati (gu)</option>
        <option value="kn">‡≤ï‡≤®‡≥ç‡≤®‡≤° / Kannada (kn)</option>
        <option value="ml">‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç / Malayalam (ml)</option>
        <option value="pa">‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä / Punjabi (pa)</option>
        <!-- M2M100 supports many more; we‚Äôre showing 20 popular ones -->
      </select>
    </div>


    <div class="mic-input-group">
      <textarea id="ingredients" rows="2" placeholder="Type ingredients or ask a question..."></textarea>
      <img id="mic-btn" src="icons8-microphone-48.png" alt="Mic" class="mic-icon" title="Speak" />
    </div>

    <div class="health-filters" id="healthFilters">
      <label><input type="checkbox" data-key="diabetes" /> Diabetes</label>
      <label><input type="checkbox" data-key="hypertension" /> Hypertension</label>
      <label><input type="checkbox" data-key="allergy_peanut" /> Allergies: Peanut</label>
      <label><input type="checkbox" data-key="low_sodium" /> Low Sodium</label>
      <label><input type="checkbox" data-key="vegetarian" /> Vegetarian</label>
      <label><input type="checkbox" data-key="vegan" /> Vegan</label>
      <label><input type="checkbox" data-key="gluten_free" /> Gluten Free</label>
      <label><input type="checkbox" data-key="dairy_free" /> Dairy Free</label>
      <label><input type="checkbox" data-key="keto" /> Keto</label>
      <label><input type="checkbox" data-key="paleo" /> Paleo</label>
      <label><input type="checkbox" data-key="heart_health" /> Heart Health</label>
      <label><input type="checkbox" data-key="renal" /> Renal Friendly</label>
      <label><input type="checkbox" data-key="weight_loss" /> Weight Loss</label>
      <label><input type="checkbox" data-key="high_protein" /> High Protein</label>
      <label><input type="checkbox" data-key="low_fat" /> Low Fat</label>
      <label><input type="checkbox" data-key="low_carb" /> Low Carb</label>
      <label><input type="checkbox" data-key="pregnancy" /> Pregnancy Safe</label>
      <label><input type="checkbox" data-key="children" /> Kid Friendly</label>
      <label><input type="checkbox" data-key="senior" /> Senior Friendly</label>
    </div>

    <div class="actions">
      <button class="btn btn-primary" id="btnFind">üîç Find Recipes</button>
      <!-- <button class="btn btn-stop" id="btnStop">‚èπ Stop</button> -->
    </div>

    <div id="activeChatNotice" class="muted" style="text-align:center;"></div>

    <div class="recipes">
      <div id="recipes"></div> <!-- Only recipe cards go here -->
    </div>

    <div class="chat-history" id="chatHistory" style="margin-top:32px;">
      <h3 style="margin-bottom:12px;">Chat History</h3>
    </div>


      <!-- Recipe Cards Will Appear Here -->
    </div>
  </div>

  <!-- Qt WebChannel bridge (provided by PyQt) -->
<script>
  // escape helper (add this)
  function escapeHtml(s=''){
    return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }
  // turn a string like `"a","b","c"` or a blob into an array
  function splitSmart(val){
    if (Array.isArray(val)) return val.flatMap(splitSmart);
    if (val == null) return [];
    let s = String(val).trim().replace(/\\+$/,'');           // drop trailing backslashes
    s = s.replace(/^\[|\]$/g,'');                            // strip [ ]
    if (/"\s*,\s*"/.test(s) || /^".*"$/.test(s)) {           // "a","b","c"
      return s.replace(/^"+|"+$/g,'').split(/"\s*,\s*"/).map(x=>x.replace(/^"+|"+$/g,'').trim()).filter(Boolean);
    }
    if (/\n/.test(s))  return s.split(/\n+/).map(x=>x.trim()).filter(Boolean);
    if (/\d+\.\s/.test(s)) return s.split(/\d+\.\s/g).map(x=>x.trim()).filter(Boolean); // 1. step 2. step
    return s.split(/\s*,\s*|;\s*/).map(x=>x.replace(/^"+|"+$/g,'').trim()).filter(Boolean);
  }

document.addEventListener('DOMContentLoaded', () => {
  // --- New Chat ---  [B] AUTO‚ÄëACTIVATE THE CHAT YOU JUST CREATED
  document.getElementById('btnNewChat').addEventListener('click', async () => {
    const title = prompt('Name this chat:', 'My Ingredients');
    if (!title) return;

    const created = await fetch('/api/chats', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({title})
    }).then(r=>r.json());

    await loadChats(); // repaints sidebar buttons

    // server: mark it active
    await fetch('/api/active_chat', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ path: created.path })
    });

    // UI: call setActiveChat to refresh history for the NEW chat
    const btn = [...document.querySelectorAll('.chat-item')]
      .find(b => b.dataset && b.dataset.path === created.path);
    if (btn) {
      await setActiveChat(created.path, created.title, btn);
    } else {
      document.getElementById('activeChatNotice').textContent = `Active chat: ${created.title}`;
    }
  });

  async function loadChats(){
    const res = await fetch('/api/chats');
    const chats = await res.json();
    const chatList = document.getElementById('chatList');
    chatList.innerHTML = '';

    chats.forEach(c=>{
      const btn = document.createElement('button');
      btn.className = 'chat-item';
      btn.textContent = `üóÇ ${c.title}`;
      btn.dataset.path = c.path;
      btn.dataset.title = c.title;
      btn.onclick = ()=>setActiveChat(c.path, c.title, btn);
      chatList.appendChild(btn);
    });

    // mark whichever chat is currently active
    const ac = await fetch('/api/active_chat').then(r=>r.json()).catch(()=>null);
    if (ac && ac.path) {
      const activeBtn = [...document.querySelectorAll('.chat-item')]
        .find(b => b.dataset.path === ac.path);
      if (activeBtn) {
        [...document.querySelectorAll('.chat-item')].forEach(el=>el.classList.remove('active'));
        activeBtn.classList.add('active');
        document.getElementById('activeChatNotice').textContent = `Active chat: ${activeBtn.dataset.title}`;
      }
    }
  }


async function renderChatHistory(){
  const historyBox = document.getElementById("chatHistory");
  historyBox.innerHTML = `<h3 style="margin-bottom:12px;">Chat History</h3>`;

  const res = await fetch('/api/chat_history');
  const history = (await res.json()).sort((a,b)=>(b.ts||'').localeCompare(a.ts||''));

  history.forEach(m => {
    const msg = document.createElement('div');
    msg.className = 'chat-msg';
    msg.style.marginBottom = "16px";

    // Header (You / AI)
    const header = document.createElement('div');
    header.style.fontWeight = 'bold';
    header.style.color = m.role === 'user' ? '#007bff' : '#333';
    header.textContent = m.role === 'user' ? 'üßç You' : 'ü§ñ AI';

    // Body
    const body = document.createElement('div');
    body.style.marginLeft = "8px";

    if (m.role === 'assistant') {
      const rd = m?.meta?.payload?.recipe_detail;

      // Case 1: AI already returned a specific recipe (ingredients/steps present)
      if (rd && (rd.ingredients?.length || rd.steps?.length)) {
        const ings  = splitSmart(rd.ingredients);
        const steps = splitSmart(rd.steps);

        body.innerHTML = `
          <div class="recipe-card" style="background:#fff;border-radius:12px;padding:16px;box-shadow:var(--shadow);">
            ${rd.title ? `<h4 style="margin:0 0 8px 0;">üçΩÔ∏è ${escapeHtml(rd.title)}</h4>` : ''}
            <div style="font-weight:600; margin-top:6px;">Ingredients</div>
            <ul style="margin:6px 0 0 18px;">
              ${ings.map(i=>`<li>${escapeHtml(i)}</li>`).join('')}
            </ul>
            <div style="font-weight:600; margin-top:12px;">Steps</div>
            <ol style="margin:6px 0 0 18px;">
              ${steps.map(s=>`<li>${escapeHtml(s)}</li>`).join('')}
            </ol>
            <div style="display:flex; gap:8px; margin-top:12px;">
              <button class="nutrition-btn" type="button"
                      style="background:#00a6a6;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;">
                üçé Nutrition
              </button>
              <button class="health-btn" type="button"
                      style="background:#00a6a6;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;">
                ‚ù§Ô∏è Health Check
              </button>
            </div>
          </div>
        `;

        // Wire Nutrition
        const nbtn = body.querySelector('.nutrition-btn');
        nbtn.addEventListener('click', (e) => {
          const card = e.currentTarget.closest('.recipe-card');
          showNutrition(ings, card);
        });

        // Wire Health
        const hbtn = body.querySelector('.health-btn');
        // replace the whole Health button listener with this

        hbtn.addEventListener('click', async (e) => {
          const displayLang = document.getElementById('displayLang').value || 'auto';
          const card = e.currentTarget.closest('.recipe-card');

          try {
            const r = await fetch('/api/health_check', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ display_lang: displayLang })
            });

            // If the server appended a chat message but didn't return a text payload,
            // we still want the UI to show it by re-rendering chat history.
            let data = {};
            try { data = await r.json(); } catch(_) {}

            const ok   = r.ok && (data.ok !== false); // accept truthy or missing
            const text = (data && (data.text || data.summary)) || '';

            // Inline box if text came back:
            if (ok && text) {
              // one box per card
              let box = card.querySelector('.health-box');
              if (box) box.remove();

              box = document.createElement('div');
              box.className = 'health-box';
              box.style.marginTop = '10px';
              box.style.padding = '10px';
              box.style.borderRadius = '6px';
              box.style.whiteSpace = 'pre-wrap';
              box.style.background = '#e8f7ed';
              box.style.border = '1px solid #2e7d32';

              const h = document.createElement('div');
              h.style.fontWeight = '600';
              h.style.marginBottom = '6px';
              h.textContent = 'ü©∫ Health Check';

              const pre = document.createElement('pre');
              pre.style.whiteSpace = 'pre-wrap';
              pre.style.margin = 0;
              pre.textContent = text;

              box.appendChild(h);
              box.appendChild(pre);
              card.appendChild(box);
              box.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else if (ok) {
              // No inline text (but server stored it) ‚Üí refresh history to show saved block
              await renderChatHistory();
            } else {
              alert('Health check failed.');
            }
          } catch (err) {
            console.error('[ui] health_check error:', err);
            alert('Health check failed.');
          }
        });

      } else {
        // Case 2: AI listed multiple recipe suggestions ‚Äî render list as clickable items
        const raw = (m.content || '');
        const lines = raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);

        // keep only list-looking lines (‚Ä¢, -, *, or 1.)
        const listItems = lines
          .filter(s => /^([‚Ä¢\-\*\u2022]|\d+\.)\s*/.test(s))
          .map(s => s.replace(/^([‚Ä¢\-\*\u2022]|\d+\.)\s*/, ''))
          .filter(Boolean);

        if (listItems.length >= 3) {
          const ul = document.createElement('ul');

          listItems.forEach(titleText => {
            const li = document.createElement('li');

            const btn = document.createElement('button');
            btn.type = 'button';
            btn.textContent = titleText;
            btn.style.border = 'none';
            btn.style.background = 'transparent';
            btn.style.cursor = 'pointer';
            btn.style.textDecoration = 'underline';
            btn.style.padding = '0';

            // ‚¨áÔ∏è SAVE SELECTION + RE-RENDER (no inline expansion)
            btn.addEventListener('click', async () => {
              const display_lang = document.getElementById('displayLang').value || 'auto';
              await fetch('/api/get_recipe_detail', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ title: titleText, display_lang })
              });
              await renderChatHistory(); // shows "Selected recipe: ..." + recipe card
            });

            li.appendChild(btn);
            ul.appendChild(li);
          });

          body.innerHTML = '';
          body.appendChild(ul);
        } else {
          // Fallback: just render the text if it doesn't look like a list of suggestions
          body.style.whiteSpace = 'pre-wrap';
          body.textContent = raw;
        }
      }
    } else {
      // User message
      body.style.whiteSpace = "pre-wrap";
      body.textContent = m.content || '';
    }

    msg.appendChild(header);
    msg.appendChild(body);
    historyBox.appendChild(msg);
  });
}

  // setActiveChat now reuses the renderer
  async function setActiveChat(path, title, btn){
    window.activeChatPath = path;

    await fetch('/api/active_chat', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({path})
    });

    // UI selection state
    [...document.querySelectorAll('.chat-item')].forEach(el=>el.classList.remove('active'));
    if (btn) btn.classList.add('active');
    document.getElementById('activeChatNotice').textContent = `Active chat: ${title}`;

    // render newest-first history with clickable suggestions
    await renderChatHistory();
  }

  // --- Health Filters Save ---
  document.getElementById('healthFilters').addEventListener('change', async ()=>{
    const f = {diabetes:false,hypertension:false,allergies:[],low_sodium:false,vegetarian:false,vegan:false};
    document.querySelectorAll('#healthFilters input[type=checkbox]').forEach(b=>{
      const key = b.dataset.key;
      if (key === 'allergy_peanut'){ if(b.checked) f.allergies.push('peanut'); }
      else { f[key] = b.checked; }
    });
    await fetch('/api/health_filters',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(f)});
  });

  // --- Find Recipes ---  [A] ENSURE AN ACTIVE CHAT BEFORE SAVING
  document.getElementById('btnFind').addEventListener('click', async ()=>{
    // ensure there is an active chat
    const ac = await fetch('/api/active_chat').then(r=>r.json());
    if (!ac || !ac.path) {
      const created = await fetch('/api/chats', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ title: 'Ingredients' })
      }).then(r=>r.json());

      await fetch('/api/active_chat', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ path: created.path })
      });

      await loadChats();

      const btn = [...document.querySelectorAll('.chat-item')]
        .find(b => b.dataset && b.dataset.path === created.path);
      if (btn) await setActiveChat(created.path, created.title, btn);
    }

    const ing = document.getElementById('ingredients').value || '';
    const display_lang = (document.getElementById('displayLang').value || 'auto');

    // Send the selected language to backend (currency removed)
    await fetch('/api/find_recipes',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ ingredients: ing, display_lang })
    }).then(r=>r.json());

    // Reload chat history so the new reply appears
    await renderChatHistory();
  });

  // initial load
  loadChats().then(renderChatHistory);
});
</script>

<script>
document.getElementById('mic-btn').addEventListener('click', async () => {
  try {
    const micBtn = document.getElementById("mic-btn");
    micBtn.classList.add("listening");
    micBtn.title = "Listening...";

    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const mediaRecorder = new MediaRecorder(stream);
    let chunks = [];

    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.start();

    await new Promise(r => setTimeout(r, 5000));
    mediaRecorder.stop();

    await new Promise(resolve => mediaRecorder.onstop = resolve);

    const audioBlob = new Blob(chunks, { type: 'audio/wav' });
    const formData = new FormData();
    formData.append('audio', audioBlob);

    const response = await fetch('/api/voice_input', {
      method: 'POST',
      body: formData
    });
    const data = await response.json();

    if(data.text){
      document.getElementById('ingredients').value = data.text;
      document.getElementById('btnFind').click();
    } else if(data.error) {
      alert('Voice error: ' + data.error);
    }

    stream.getTracks().forEach(track => track.stop());
  } catch (err) {
    alert('Voice capture failed: ' + err.message);
  } finally {
    const micBtn = document.getElementById("mic-btn");
    micBtn.classList.remove("listening");
    micBtn.title = "Speak";
  }
});
</script>

<script>
  async function getNutrition(title){
    const res = await fetch('/api/get_nutrition', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ title })
    });
    const data = await res.json();
    const box = document.getElementById("nutrition-box-" + title.replace(/\s+/g,'_'));
    box.innerHTML = data && data.text ? `<strong>Nutrition Info:</strong><br/><pre>${data.text}</pre>` : "No info found.";
  }
</script>

<script>
async function showNutrition(ingredients, containerEl){
  try {
    const displayLang = document.getElementById("displayLang").value || "auto";
    const res = await fetch('/api/check_nutrition', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ingredients, display_lang: displayLang })
    });
    const data = await res.json();
    const text = data?.text || "No nutrition data found.";

    const card = containerEl || document.querySelector('.recipe-card:last-of-type');
    if (!card) return;

    // one box per card
    const old = card.querySelector('.nutrition-box');
    if (old) old.remove();

    const box = document.createElement('div');
    box.className = 'nutrition-box';
    box.style.marginTop = '10px';
    box.style.padding = '10px';
    box.style.background = '#f4f4f4';
    box.style.borderRadius = '6px';
    box.style.whiteSpace = 'pre-wrap';
    box.textContent = text;

    card.appendChild(box);
    box.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  } catch (e) {
    console.error(e);
    alert('‚ùå Failed to load nutrition info.');
  }
}

</script>


<!-- Existing scripts like showNutritionPopup, etc. -->

<script>
// ========== ADD THIS FUNCTION ==========
function renderNutritionButtons() {
  document.querySelectorAll(".chat-msg").forEach(msg => {
    const msgData = msg.dataset.message && JSON.parse(msg.dataset.message);
    if (!msg.querySelector('.btn-nutrition') && msgData?.meta?.payload?.recipe_detail?.ingredients) {
      const btn = document.createElement('button');
      btn.textContent = 'Nutrition';
      btn.className = 'btn-nutrition';
      btn.style.backgroundColor = '#00a6a6';
      btn.style.color = 'white';
      btn.style.border = 'none';
      btn.style.padding = '4px 10px';
      btn.style.marginLeft = '10px';
      btn.style.borderRadius = '5px';
      btn.style.cursor = 'pointer';

      btn.addEventListener('click', async () => {
        const ingredients = msgData.meta.payload.recipe_detail.ingredients || [];
        if (!ingredients.length) {
          showPopup("‚ùå No ingredients found for this message.");
          return;
        }

        try {
          const response = await fetch('/api/check_nutrition', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ingredients })
          });

          const data = await response.json();
          const nutritionText = data.text || "‚ùå No nutrition data returned.";

          const existingBox = msg.querySelector(".nutrition-box");
          if (existingBox) existingBox.remove();

          const box = document.createElement("div");
          box.className = "nutrition-box";
          box.innerHTML = `<strong>Nutrition Info:</strong><br/>${nutritionText.replace(/\n/g, "<br/>")}`;
          msg.appendChild(box);

        } catch (err) {
          showPopup("‚ùå Failed to load nutrition data.");
        }
      });

      msg.appendChild(btn);
    }
  });
}


function showPopup(text) {
  let popup = document.createElement('div');
  popup.innerHTML = text;
  popup.style.position = 'fixed';
  popup.style.bottom = '30px';
  popup.style.right = '30px';
  popup.style.maxWidth = '300px';
  popup.style.padding = '15px';
  popup.style.backgroundColor = '#fff';
  popup.style.border = '1px solid #ccc';
  popup.style.borderRadius = '10px';
  popup.style.boxShadow = '0 0 10px rgba(0,0,0,0.2)';
  popup.style.zIndex = 10000;

  const close = document.createElement('span');
  close.innerHTML = '&times;';
  close.style.float = 'right';
  close.style.cursor = 'pointer';
  close.style.fontSize = '18px';
  close.style.marginLeft = '10px';
  close.onclick = () => popup.remove();

  popup.prepend(close);
  document.body.appendChild(popup);
}
</script>



<div id="nutritionPopup" class="nutrition-popup">
  <span class="nutrition-popup-close" onclick="document.getElementById('nutritionPopup').style.display='none'">&times;</span>
  <div id="nutritionContent">Loading nutrition info...</div>
</div>

<footer style="
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: #f9f9f9;
    text-align: center;
    padding: 8px;
    font-size: 0.85rem;
    color: #666;
    border-top: 1px solid #ddd;
">
  ‚ö†Ô∏è Nutritional value may not be accurate and this bot isn‚Äôt responsible for any health issues caused.
</footer>

<script>
// ========== ADD THIS FUNCTION ==========
function extractIngredientsFromChat() {
  const aiMessages = document.querySelectorAll(".message.ai");
  for (let i = aiMessages.length - 1; i >= 0; i--) {
    const message = aiMessages[i].innerText;
    const match = message.match(/Ingredients:\s*([-‚Äì‚Ä¢\d\w\,\s"']+)/i);
    if (match) {
      const ingredientsRaw = match[1];
      const ingredients = ingredientsRaw
        .split(/[,‚Ä¢-]/)
        .map(s => s.replace(/["']/g, '').trim().toLowerCase())
        .filter(Boolean);
      return [...new Set(ingredients)];  // remove duplicates
    }
  }
  return [];
}

document.querySelectorAll(".btn-nutrition").forEach(button => {
  button.addEventListener("click", async () => {
    // Find the ingredient list from the current chat block
    const container = button.closest(".msg") || button.closest(".chat-msg") || document;
    const ingListEl = container.querySelector("pre");

    if (!ingListEl) {
      alert("‚ö†Ô∏è Could not find ingredient list.");
      return;
    }

    const ingredientText = ingListEl.textContent || "";
    const ingredients = ingredientText
      .split(/[\r\n]+|","|", "|, /)    // split by newlines, quotes, commas
      .map(i => i.replace(/^-/, "").trim())
      .filter(i => i.length > 0);

    if (!ingredients.length) {
      alert("‚ö†Ô∏è No ingredients found.");
      return;
    }

    // Send to backend
    const res = await fetch("/api/check_nutrition", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ ingredients })
    });

    const data = await res.json();
    const text = data.text || "‚ùå No nutrition data found.";

    // Inject below the button (avoid duplication)
    const existingBox = button.parentElement.querySelector(".nutrition-box");
    if (existingBox) existingBox.remove();

    const nutritionBox = document.createElement("div");
    nutritionBox.className = "nutrition-box";
    nutritionBox.textContent = text;
    button.parentElement.appendChild(nutritionBox);
  });
});

</script>

<!-- Your other HTML content -->

<!-- ADD THIS BLOCK BEFORE </body> -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".btn-nutrition").forEach((button) => {
      button.addEventListener("click", async () => {
        try {
          const res = await fetch("/api/check_nutrition", {
            method: "POST",
          });

          const data = await res.json();
          const nutritionText = data.text || "‚ùå No nutrition data returned.";

          const nutritionBox = document.createElement("div");
          nutritionBox.className = "nutrition-box";
          nutritionBox.textContent = nutritionText;

          const existingBox = button.parentElement.querySelector(".nutrition-box");
          if (existingBox) existingBox.remove();

          button.parentElement.appendChild(nutritionBox);
        } catch (e) {
          console.error("Nutrition fetch failed:", e);
          alert("‚ùå Failed to get nutrition info");
        }
      });
    });
  });
</script>

<style>
.nutrition-box {
  margin-top: 10px;
  padding: 10px;
  background-color: #f4f4f4;
  border-radius: 5px;
  font-family: monospace;
  white-space: pre-wrap;
}
</style>

</body>
</html>
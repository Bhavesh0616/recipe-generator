name: Build mac app

on:
  workflow_dispatch:

jobs:
  mac-build:
    # Intel runner (good PyInstaller compatibility). Use macos-14 if you want Apple Silicon.
    runs-on: macos-13

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip wheel setuptools
          # your app deps
          pip install -r requirements.txt
          # build/runtime deps that PyInstaller needs
          pip install pyinstaller transformers sentencepiece torch

      # If your repo already contains the models and CSV under these paths,
      # there is nothing else to download/unzip.

      - name: Build .app with PyInstaller
        run: |
          # Build the macOS app bundle. --windowed gives a "normal" app (no console).
          pyinstaller \
            --name FoodChat \
            --windowed \
            --icon app_icon.ico \
            --add-data "frontend_food_chat.html:." \
            --add-data "icons8-microphone-48.png:." \
            --add-data "LICENSE.txt:." \
            --add-data "assets/cleaned_ingredients.csv:assets" \
            --add-data "assets/translation_models:assets/translation_models" \
            --add-data "assets/models--openai--whisper-small:assets/models--openai--whisper-small" \
            --add-data "models/mistral-7b-instruct-v0.2:models/mistral-7b-instruct-v0.2" \
            launch.py

      - name: Zip app
        run: |
          cd dist
          zip -r FoodChat-mac.zip FoodChat.app

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: FoodChat-mac
          path: dist/FoodChat-mac.zip
          retention-days: 14
